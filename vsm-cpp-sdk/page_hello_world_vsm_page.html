
<!DOCTYPE html>

<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>“Hello world” VSM application &#8212; CPP VSM SDK  documentation</title>
    
  <link href="_static/css/theme.css" rel="stylesheet" />
  <link href="_static/css/index.c5995385ac14fb8791e8eb36b4908be2.css" rel="stylesheet" />

    
  <link rel="stylesheet"
    href="_static/vendor/fontawesome/5.13.0/css/all.min.css">
  <link rel="preload" as="font" type="font/woff2" crossorigin
    href="_static/vendor/fontawesome/5.13.0/webfonts/fa-solid-900.woff2">
  <link rel="preload" as="font" type="font/woff2" crossorigin
    href="_static/vendor/fontawesome/5.13.0/webfonts/fa-brands-400.woff2">

    
      

    
    <link rel="stylesheet" type="text/css" href="_static/pygments.css" />
    <link rel="stylesheet" type="text/css" href="_static/basic.css" />
    <link rel="stylesheet" type="text/css" href="_static/doxyrest-pygments.css" />
    
  <link rel="preload" as="script" href="_static/js/index.1c5a1a01449ed65a7b51.js">

    <script data-url_root="./" id="documentation_options" src="_static/documentation_options.js"></script>
    <script src="_static/jquery.js"></script>
    <script src="_static/underscore.js"></script>
    <script src="_static/doctools.js"></script>
    <script src="_static/target-highlight.js"></script>
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
    <link rel="next" title="License" href="page_license_page.html" />
    <link rel="prev" title="Tutorials" href="page_tutorials_page.html" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="docsearch:language" content="en" />
    
  </head>
  <body data-spy="scroll" data-target="#bd-toc-nav" data-offset="80">
    
    <div class="container-fluid" id="banner"></div>

    
    <nav class="navbar navbar-light navbar-expand-lg bg-light fixed-top bd-navbar" id="navbar-main"><div class="container-xl">

  <div id="navbar-start">
    
    

<a class="navbar-brand" href="index.html">
  <img src="_static/logo.png" class="logo" alt="logo">
</a>


    
  </div>

  <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbar-collapsible" aria-controls="navbar-collapsible" aria-expanded="false" aria-label="Toggle navigation">
    <span class="navbar-toggler-icon"></span>
  </button>

  
  <div id="navbar-collapsible" class="col-lg-9 collapse navbar-collapse">
    <div id="navbar-center" class="mr-auto">
      
      <div class="navbar-center-item">
        <ul id="navbar-main-elements" class="navbar-nav">
    <li class="toctree-l1 nav-item">
 <a class="reference internal nav-link" href="page_ucs_vsm_overview_page.html">
  Overview
 </a>
</li>

<li class="toctree-l1 nav-item">
 <a class="reference internal nav-link" href="page_getting_started.html">
  Getting Started
 </a>
</li>

<li class="toctree-l1 nav-item">
 <a class="reference internal nav-link" href="page_ucs_vsm_manual_page.html">
  Manual
 </a>
</li>

<li class="toctree-l1 current active nav-item">
 <a class="reference internal nav-link" href="page_tutorials_page.html">
  Tutorials
 </a>
</li>

<li class="toctree-l1 nav-item">
 <a class="reference internal nav-link" href="page_license_page.html">
  License
 </a>
</li>

<li class="toctree-l1 nav-item">
 <a class="reference internal nav-link" href="examples.html">
  Examples
 </a>
</li>

<li class="toctree-l1 nav-item">
 <a class="reference internal nav-link" href="global.html">
  Global Namespace
 </a>
</li>

    
    <li class="nav-item">
        <a class="nav-link nav-external" href="https://www.ugcs.com/">UgCS<i class="fas fa-external-link-alt"></i></a>
    </li>
    
</ul>
      </div>
      
    </div>

    <div id="navbar-end">
      
      <div class="navbar-end-item">
        <ul id="navbar-icon-links" class="navbar-nav" aria-label="Icon Links">
        <li class="nav-item">
          <a class="nav-link" href="https://github.com/ugcs/vsm-cpp-sdk" rel="noopener" target="_blank" title="GitHub">
            <span><i class="fab fa-github-square"></i></span>
            <label class="sr-only">GitHub</label>
          </a>
        </li>
      </ul>
      </div>
      
    </div>
  </div>
</div>
    </nav>
    

    <div class="container-xl">
      <div class="row">
          
            
            <!-- Only show if we have sidebars configured, else just a small margin  -->
            <div class="col-12 col-md-3 bd-sidebar"><form class="bd-search d-flex align-items-center" action="search.html" method="get">
  <i class="icon fas fa-search"></i>
  <input type="search" class="form-control" name="q" id="search-input" placeholder="Search the docs ..." aria-label="Search the docs ..." autocomplete="off" >
</form><nav class="bd-links" id="bd-docs-nav" aria-label="Main navigation">
  <div class="bd-toc-item active">
    <ul class="current nav bd-sidenav">
 <li class="toctree-l1 current active">
  <a class="current reference internal" href="#">
   “Hello world” VSM application
  </a>
 </li>
</ul>

  </div>
</nav>
            </div>
            
          

          
          <div class="d-none d-xl-block col-xl-2 bd-toc">
            
              
              <div class="toc-item">
                
<div class="tocsection onthispage pt-5 pb-3">
    <i class="fas fa-list"></i> On this page
</div>

<nav id="bd-toc-nav">
    <ul class="visible nav section-nav flex-column">
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#c-code">
   C++ code
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#cmake-makefile">
   CMake makefile
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#compilation">
   Compilation
  </a>
  <ul class="nav section-nav flex-column">
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#building">
     Building
    </a>
   </li>
  </ul>
 </li>
</ul>

</nav>
              </div>
              
              <div class="toc-item">
                
              </div>
              
            
          </div>
          

          
          
            
          
          <main class="col-12 col-md-9 col-xl-7 py-md-5 pl-md-5 pr-md-4 bd-content" role="main">
              
              <div>
                
  <div class="section" id="hello-world-vsm-application">
<span id="doxid-d8-db6-hello-world-vsm-page"></span><span id="index-0"></span><h1>“Hello world” VSM application<a class="headerlink" href="#hello-world-vsm-application" title="Permalink to this headline">¶</a></h1>
<p>Here is an example of a simple VSM application which demonstrates basic usage of the SDK. The source code of this example consists of two files:</p>
<ul class="simple">
<li><p>CMake makefile <a class="reference internal" href="example_Hello_world_VSM_CMakeLists.txt.html#doxid-dc-d9c-hello-world-v-s-m-2-c-make-lists-8txt-example"><span class="std std-ref">Hello_world_VSM/CMakeLists.txt</span></a>.</p></li>
<li><p>C++ source code file <a class="reference internal" href="example_hello_world_vsm.cpp.html#doxid-d5-d58-hello-world-vsm-8cpp-example"><span class="std std-ref">hello_world_vsm.cpp</span></a>.</p></li>
</ul>
<div class="section" id="c-code">
<span id="doxid-d8-db6-hello-world-vsm-page-1c-plus-plus-hello-world"></span><h2>C++ code<a class="headerlink" href="#c-code" title="Permalink to this headline">¶</a></h2>
<p>Single header file should be included to get an access to the whole SDK functionality:</p>
<pre class="highlight literal-block"><span></span><span class="cp">#include</span> <span class="cpf">&lt;ugcs/vsm/vsm.h&gt;</span></pre>
<p>All the SDK functionality resides under <a class="reference internal" href="namespace_ugcs_vsm.html#doxid-dd-def-namespaceugcs-1-1vsm"><span class="std std-ref">ugcs::vsm</span></a> namespace.</p>
<p>Custom vehicle class should be defined by deriving from a <a class="reference internal" href="class_ugcs_vsm_Device.html#doxid-d1-dfa-classugcs-1-1vsm-1-1-device"><span class="std std-ref">ugcs::vsm::Device</span></a> class:</p>
<pre class="highlight literal-block"><span></span><span class="k">class</span> <span class="nl">Custom_vehicle</span><span class="p">:</span><span class="k">public</span> <a class="reference internal" href="class_ugcs_vsm_Device.html#doxid-d1-dfa-classugcs-1-1vsm-1-1-device"><span class="std std-ref">ugcs::vsm::Device</span></a><span></span>
<span class="p">{</span>
    <span class="cm">/* To add shared pointer capability to this class. */</span>
    <a class="reference internal" href="global.html#doxid-d5-d60-utils-8h-1add7ad4e26c0e697e6eadb8da66c3e60d"><span class="std std-ref">DEFINE_COMMON_CLASS</span></a><span></span><span class="p">(</span><span class="n">Custom_vehicle</span><span class="p">,</span> <a class="reference internal" href="class_ugcs_vsm_Device.html#doxid-d1-dfa-classugcs-1-1vsm-1-1-device"><span class="std std-ref">ugcs::vsm::Device</span></a><span></span><span class="p">)</span></pre>
<p>To pass the instance of custom class to SDK, shared pointer of the form <a class="reference external" href="http://en.cppreference.com/w/cpp/memory/shared_ptr">std::shared_ptr&lt;Custom_vehicle&gt;</a> should be used. Macro <a class="reference internal" href="global.html#doxid-d5-d60-utils-8h-1add7ad4e26c0e697e6eadb8da66c3e60d"><span class="std std-ref">DEFINE_COMMON_CLASS</span></a> defines methods and member types needed for shared pointers usage:</p>
<ul>
<li><p><em>Class::Ptr</em> member type which effectively is <em>std::shared_ptr&lt;Class&gt;</em>.</p></li>
<li><p><em>Class::Weak_ptr</em> member type which effectively is <em>std::weak_ptr&lt;Class&gt;</em>.</p></li>
<li><p><em>static Class::Create()</em> template method for convenient creation of shared classes dynamically:</p>
<pre class="highlight literal-block"><span></span><span class="cm">/* Create vehicle instance with hard-coded serial number. */</span>
<span class="n">Custom_vehicle</span><span class="o">::</span><span class="n">Ptr</span> <span class="n">vehicle</span> <span class="o">=</span> <span class="n">Custom_vehicle</span><span class="o">::</span><span class="n">Create</span><span class="p">(</span><span class="s">&quot;asd123456&quot;</span><span class="p">);</span></pre>
</li>
<li><p><em>Class::Shared_from_this()</em> method which returns appropriate <em>Class::Ptr</em> shared pointer:</p>
<pre class="highlight literal-block"><a class="reference internal" href="namespace_ugcs_vsm.html#doxid-dd-def-namespaceugcs-1-1vsm-1ad0409b84278bc4bc1c8db2c993681dad"><span class="std std-ref">ugcs::vsm::Make_callback</span></a><span></span><span class="p">(</span><span class="o">&amp;</span><span class="n">Custom_vehicle</span><span class="o">::</span><span class="n">Send_telemetry</span><span class="p">,</span> <span class="n">Shared_from_this</span><span class="p">()),</span></pre>
</li>
</ul>
<p>UgCS differentiates vehicles based on serial number and name. We use required parameters for that in our vehicle constructor:</p>
<pre class="highlight literal-block"><span></span><span class="n">Custom_vehicle</span><span class="p">(</span><span class="k">const</span> <span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="o">&amp;</span> <span class="n">serial_number</span><span class="p">)</span><span class="o">:</span>
    <span class="n">Device</span><span class="p">(</span><a class="reference internal" href="namespace_ugcs.html#doxid-d1-d6b-namespaceugcs"><span class="std std-ref">ugcs</span></a><span></span><span class="o">::</span><span class="n">vsm</span><span class="o">::</span><span class="n">proto</span><span class="o">::</span><span class="n">DEVICE_TYPE_VEHICLE</span><span class="p">)</span>
<span class="p">{</span></pre>
<p>Currently, vehicle and autopilot types are defined by using types from <a class="reference internal" href="namespace_ugcs_vsm_mavlink.html#doxid-d3-d55-namespaceugcs-1-1vsm-1-1mavlink"><span class="std std-ref">ugcs::vsm::mavlink</span></a> namespace, but it will be changed in next releases. It is fully up to VSM application developer to decide about custom vehicle constructor arguments, but usually at least vehicle serial number is configurable while vehicle/autopilot types, model name and capabilities are fixed.</p>
<p>Next step is to decide whether override of <span class="xref std std-ref">ugcs::vsm::Device::On_enable</span> method is needed or not. As a general rule, override is needed if some class-level initialization actions require <em>this</em> shared pointer usage, for example, telemetry simulation timer creation and setting of system status:</p>
<pre class="highlight literal-block"><span></span><span class="k">virtual</span> <span class="kt">void</span>
<span class="nf">On_enable</span><span class="p">()</span> <span class="k">override</span>
<span class="p">{</span>
    <span class="n">timer</span> <span class="o">=</span> <a class="reference internal" href="class_ugcs_vsm_Timer_processor.html#doxid-dc-dae-classugcs-1-1vsm-1-1-timer-processor-1a19a7b34dd02aba6468e644d1c91026aa"><span class="std std-ref">ugcs::vsm::Timer_processor::Get_instance</span></a><span></span><span class="p">()</span><span class="o">-&gt;</span><span class="n">Create_timer</span><span class="p">(</span>
            <span class="cm">/* Telemetry with 1 second granularity. */</span>
            <span class="n">std</span><span class="o">::</span><span class="n">chrono</span><span class="o">::</span><span class="n">seconds</span><span class="p">(</span><span class="mi">1</span><span class="p">),</span>
            <span class="cm">/* Send_telemetry method will be called on timer. Smart pointer</span>
<span class="cm">             * is used to reference vehicle instance. Plain &#39;this&#39; could also</span>
<span class="cm">             * be used here, but it is generally not recommended. */</span>
            <a class="reference internal" href="namespace_ugcs_vsm.html#doxid-dd-def-namespaceugcs-1-1vsm-1ad0409b84278bc4bc1c8db2c993681dad"><span class="std std-ref">ugcs::vsm::Make_callback</span></a><span></span><span class="p">(</span><span class="o">&amp;</span><span class="n">Custom_vehicle</span><span class="o">::</span><span class="n">Send_telemetry</span><span class="p">,</span> <span class="n">Shared_from_this</span><span class="p">()),</span>
            <span class="cm">/* Execution will be done in default vehicle context,</span>
<span class="cm">             * which is served by dedicated vehicle thread together with</span>
<span class="cm">             * vehicle requests so additional synchronization is not necessary.</span>
<span class="cm">             */</span>
            <span class="n">Get_completion_ctx</span><span class="p">());</span>

    <span class="cm">/* Report current control mode to the UgCS */</span>
    <span class="n">t_control_mode</span><span class="o">-&gt;</span><span class="n">Set_value</span><span class="p">(</span><span class="n">ugcs</span><span class="o">::</span><span class="n">vsm</span><span class="o">::</span><span class="n">proto</span><span class="o">::</span><span class="n">CONTROL_MODE_MANUAL</span><span class="p">);</span>

    <span class="cm">/* Report link state to the UgCS */</span>
    <span class="n">t_downlink_present</span><span class="o">-&gt;</span><span class="n">Set_value</span><span class="p">(</span><span class="nb">true</span><span class="p">);</span>
    <span class="n">t_uplink_present</span><span class="o">-&gt;</span><span class="n">Set_value</span><span class="p">(</span><span class="nb">true</span><span class="p">);</span>

    <span class="cm">/* Tell UgCS about available commands.</span>
<span class="cm">     * Command availability can be changed during runtime via this call and</span>
<span class="cm">     * VSM can determine which command buttons to show in the client UI. */</span>
    <span class="n">c_arm</span><span class="o">-&gt;</span><span class="n">Set_available</span><span class="p">();</span>
    <span class="n">c_disarm</span><span class="o">-&gt;</span><span class="n">Set_available</span><span class="p">();</span>
    <span class="n">c_mission_upload</span><span class="o">-&gt;</span><span class="n">Set_available</span><span class="p">();</span>

    <span class="cm">/* Mission upload is always enabled.</span>
<span class="cm">    * Command state (enabled/disabled) can be changed during runtime via this call and</span>
<span class="cm">    * VSM can determine which command buttons to show as enabled in the client UI. */</span>
    <span class="n">c_mission_upload</span><span class="o">-&gt;</span><span class="n">Set_enabled</span><span class="p">();</span>
    <span class="n">Commit_to_ucs</span><span class="p">();</span>
<span class="p">}</span></pre>
<p>As a rule, <span class="xref std std-ref">ugcs::vsm::Device::On_disable</span> method override is also necessary if <span class="xref std std-ref">ugcs::vsm::Device::On_enable</span> is overridden. In the example, the counterpart action is performed in <em>On_disable</em> method, namely timer cancellation to avoid memory leaks:</p>
<pre class="highlight literal-block"><span></span><span class="k">virtual</span> <span class="kt">void</span>
<span class="nf">On_disable</span><span class="p">()</span> <span class="k">override</span>
<span class="p">{</span>
    <span class="cm">/* Turn off the timer. */</span>
    <span class="n">timer</span><span class="o">-&gt;</span><span class="n">Cancel</span><span class="p">();</span>
<span class="p">}</span></pre>
<p>Timer created in the <em>On_enable</em> method is used to simulate the telemetry generation by the vehicle and to make the “Hello world” example to be more interesting and ‘alive’.</p>
<p>All custom vehicles should override ugcs::vsm::Vehicle::Handle_ucs_request processing methods (see <a class="reference internal" href="page_vehicle_interface_page.html#doxid-da-d5e-vehicle-interface-page-1vehicle-requests-section"><span class="std std-ref">Vehicle commands</span></a>) to provide vehicle specific implementation of processing logic.</p>
<p>In a real application, all saved missions should be erased from the vehicle. In this example vehicle requests are processed synchronously, i.e. in the scope of the ugcs::vsm::Vehicle::Handle_ucs_request method itself. This is not mandatory. VSM application developer may save a copy of the request handle for deferred processing and return from the overridden method without completing the request. This way, multiple vehicle related activities can be processed in parallel, for example sending telemetry to UgCS and in the same time processing the VSM request as a complex sequence of actions executed with, probably, notable delays.</p>
<p><a class="reference internal" href="class_ugcs_vsm_Ucs_request.html#doxid-dc-df0-classugcs-1-1vsm-1-1-ucs-request"><span class="std std-ref">ugcs::vsm::Ucs_request</span></a> contains a parsed protobuf message and user is able to access all its fields directly. Later there will be a wrapper to hide the housekeeping code (native protobuf calls and exceptions).</p>
<p>Here some interesting behavior is simulated. Namely, vehicle yaw spinning and altitude climbing is started/stopped based on command.</p>
<p>The most complex and important vehicle command is mission_upload which denotes a mission to be loaded into the vehicle for latter execution. The payload of the request contains a list of sub-commands which are previously registered in Fill_register_msg() call.</p>
<pre class="highlight literal-block"><span></span><span class="kt">void</span>
<span class="n">Handle_ucs_command</span><span class="p">(</span><a class="reference internal" href="class_ugcs_vsm_Ucs_request.html#doxid-dc-df0-classugcs-1-1vsm-1-1-ucs-request-1a652d814cf8c5922dad29094a80be313c"><span class="std std-ref">ugcs::vsm::Ucs_request::Ptr</span></a><span></span> <span class="n">ucs_request</span><span class="p">)</span>
<span class="p">{</span>
    <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">c</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">c</span> <span class="o">&lt;</span> <span class="n">ucs_request</span><span class="o">-&gt;</span><span class="n">request</span><span class="p">.</span><span class="n">device_commands_size</span><span class="p">();</span> <span class="n">c</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">auto</span> <span class="o">&amp;</span><span class="n">vsm_cmd</span> <span class="o">=</span> <span class="n">ucs_request</span><span class="o">-&gt;</span><span class="n">request</span><span class="p">.</span><span class="n">device_commands</span><span class="p">(</span><span class="n">c</span><span class="p">);</span>

        <span class="k">auto</span> <span class="n">cmd</span> <span class="o">=</span> <span class="n">Get_command</span><span class="p">(</span><span class="n">vsm_cmd</span><span class="p">.</span><span class="n">command_id</span><span class="p">());</span>

        <a class="reference internal" href="global.html#doxid-d7-d7f-log-8h-1a159ca84d25a5487d8e81e4438725df19"><span class="std std-ref">LOG</span></a><span></span><span class="p">(</span><span class="s">&quot;COMMAND %s (%d) received&quot;</span><span class="p">,</span>
            <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">Get_name</span><span class="p">().</span><span class="n">c_str</span><span class="p">(),</span>
            <span class="n">vsm_cmd</span><span class="p">.</span><span class="n">command_id</span><span class="p">());</span>

        <a class="reference internal" href="class_ugcs_vsm_Property_list.html#doxid-d2-d2d-classugcs-1-1vsm-1-1-property-list"><span class="std std-ref">ugcs::vsm::Property_list</span></a><span></span> <span class="n">params</span><span class="p">;</span>

        <span class="k">try</span> <span class="p">{</span>
            <span class="k">if</span>        <span class="p">(</span><span class="n">cmd</span> <span class="o">==</span> <span class="n">c_arm</span><span class="p">)</span> <span class="p">{</span>

                <a class="reference internal" href="global.html#doxid-d7-d7f-log-8h-1a5c01521cd0033d3db4fb914d19865125"><span class="std std-ref">LOG_DEBUG</span></a><span></span><span class="p">(</span><span class="s">&quot;Vehicle armed!&quot;</span><span class="p">);</span>
                <span class="cm">/* Start yaw spinning and climbing. */</span>
                <span class="n">yaw_speed</span> <span class="o">=</span> <span class="mf">0.1</span><span class="p">;</span>
                <span class="n">climb_speed</span> <span class="o">=</span> <span class="mf">0.5</span><span class="p">;</span>

                <span class="cm">/* Simulate armed vehicle */</span>
                <span class="n">is_armed</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>

            <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">cmd</span> <span class="o">==</span> <span class="n">c_disarm</span><span class="p">)</span> <span class="p">{</span>

                <a class="reference internal" href="global.html#doxid-d7-d7f-log-8h-1a5c01521cd0033d3db4fb914d19865125"><span class="std std-ref">LOG_DEBUG</span></a><span></span><span class="p">(</span><span class="s">&quot;Vehicle disarmed.&quot;</span><span class="p">);</span>
                <span class="cm">/* Stop yaw spinning and climbing. */</span>
                <span class="n">yaw_speed</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
                <span class="n">climb_speed</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

                <span class="cm">/* Simulate disarmed vehicle */</span>
                <span class="n">is_armed</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>

            <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">cmd</span> <span class="o">==</span> <span class="n">c_disarm</span><span class="p">)</span> <span class="p">{</span>

                <a class="reference internal" href="global.html#doxid-d7-d7f-log-8h-1a5c01521cd0033d3db4fb914d19865125"><span class="std std-ref">LOG_DEBUG</span></a><span></span><span class="p">(</span><span class="s">&quot;Vehicle disarmed.&quot;</span><span class="p">);</span>
                <span class="cm">/* Stop yaw spinning and climbing. */</span>
                <span class="n">yaw_speed</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
                <span class="n">climb_speed</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

                <span class="cm">/* Simulate disarmed vehicle */</span>
                <span class="n">is_armed</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>

            <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">cmd</span> <span class="o">==</span> <span class="n">c_mission_upload</span><span class="p">)</span> <span class="p">{</span>

                <span class="cm">/* Iterate over all mission commands */</span>
                <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">item_count</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">item_count</span> <span class="o">&lt;</span> <span class="n">vsm_cmd</span><span class="p">.</span><span class="n">sub_commands_size</span><span class="p">();</span> <span class="n">item_count</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
                    <span class="k">auto</span> <span class="n">vsm_scmd</span> <span class="o">=</span> <span class="n">vsm_cmd</span><span class="p">.</span><span class="n">sub_commands</span><span class="p">(</span><span class="n">item_count</span><span class="p">);</span>
                    <span class="k">auto</span> <span class="n">cmd</span> <span class="o">=</span> <span class="n">Get_command</span><span class="p">(</span><span class="n">vsm_scmd</span><span class="p">.</span><span class="n">command_id</span><span class="p">());</span>
                    <span class="k">if</span> <span class="p">(</span><span class="n">cmd</span> <span class="o">==</span> <span class="n">c_move</span><span class="p">)</span> <span class="p">{</span>
                        <span class="cm">/* Only move is supported by this vehicle */</span>
                        <a class="reference internal" href="global.html#doxid-d7-d7f-log-8h-1a159ca84d25a5487d8e81e4438725df19"><span class="std std-ref">LOG</span></a><span></span><span class="p">(</span><span class="s">&quot;MISSION item %d %s (%d)&quot;</span><span class="p">,</span>
                            <span class="n">item_count</span><span class="p">,</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">Get_name</span><span class="p">().</span><span class="n">c_str</span><span class="p">(),</span>
                            <span class="n">vsm_scmd</span><span class="p">.</span><span class="n">command_id</span><span class="p">());</span>
                        <span class="n">params</span> <span class="o">=</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">Build_parameter_list</span><span class="p">(</span><span class="n">vsm_scmd</span><span class="p">);</span>
                        <span class="kt">float</span> <span class="n">alt</span><span class="p">;</span>
                        <span class="n">params</span><span class="p">.</span><a class="reference internal" href="class_ugcs_vsm_Property_list.html#doxid-d2-d2d-classugcs-1-1vsm-1-1-property-list-1a55157bda7d2d9c2523fcaf9582885533"><span class="std std-ref">Get_value</span></a><span></span><span class="p">(</span><span class="s">&quot;altitude&quot;</span><span class="p">,</span> <span class="n">alt</span><span class="p">);</span>
                        <a class="reference internal" href="global.html#doxid-d7-d7f-log-8h-1a5c01521cd0033d3db4fb914d19865125"><span class="std std-ref">LOG_DEBUG</span></a><span></span><span class="p">(</span><span class="s">&quot;Move to altitude of %.2f meters.&quot;</span><span class="p">,</span> <span class="n">alt</span><span class="p">);</span>
                    <span class="p">}</span>
                <span class="p">}</span>

            <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
                <a class="reference internal" href="global.html#doxid-dd-d2d-exception-8h-1a7fc579418b7ef463578555dcb09e31a4"><span class="std std-ref">VSM_EXCEPTION</span></a><span></span><span class="p">(</span><a class="reference internal" href="class_ugcs_vsm_Param_exception.html#doxid-d4-dff-classugcs-1-1vsm-1-1-param-exception"><span class="std std-ref">ugcs::vsm::Action::Format_exception</span></a><span></span><span class="p">,</span> <span class="s">&quot;Unsupported command&quot;</span><span class="p">);</span>
            <span class="p">}</span>
            <span class="n">ucs_request</span><span class="o">-&gt;</span><span class="n">Complete</span><span class="p">();</span>
        <span class="p">}</span> <span class="k">catch</span> <span class="p">(</span><span class="k">const</span> <span class="n">std</span><span class="o">::</span><span class="n">exception</span><span class="o">&amp;</span> <span class="n">ex</span><span class="p">)</span> <span class="p">{</span>
            <span class="n">ucs_request</span><span class="o">-&gt;</span><span class="n">Complete</span><span class="p">(</span><span class="n">ugcs</span><span class="o">::</span><span class="n">vsm</span><span class="o">::</span><span class="n">proto</span><span class="o">::</span><span class="n">STATUS_INVALID_PARAM</span><span class="p">,</span> <span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="p">(</span><span class="n">ex</span><span class="p">.</span><span class="n">what</span><span class="p">()));</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span></pre>
<p>Telemetry simulation is done in a single method which is regularly called by timer:</p>
<pre class="highlight literal-block"><span></span><span class="kt">bool</span>
<span class="nf">Send_telemetry</span><span class="p">()</span>
<span class="p">{</span>

    <span class="cm">/* Report current heading. */</span>
    <span class="n">t_heading</span><span class="o">-&gt;</span><span class="n">Set_value</span><span class="p">(</span><span class="n">yaw</span><span class="p">);</span>

    <span class="cm">/* Simulate some spinning between [-Pi;+Pi]. */</span>
    <span class="k">if</span> <span class="p">((</span><span class="n">yaw</span> <span class="o">+=</span> <span class="n">yaw_speed</span><span class="p">)</span> <span class="o">&gt;=</span> <a class="reference internal" href="global.html#doxid-df-db1-math-8h-1ae71449b1cc6e6250b91f539153a7a0d3"><span class="std std-ref">M_PI</span></a><span></span><span class="p">)</span> <span class="p">{</span>
        <span class="n">yaw</span> <span class="o">=</span> <span class="o">-</span><a class="reference internal" href="global.html#doxid-df-db1-math-8h-1ae71449b1cc6e6250b91f539153a7a0d3"><span class="std std-ref">M_PI</span></a><span></span><span class="p">;</span>
    <span class="p">}</span>

    <span class="cm">/* Simulate climbing high to the sky. */</span>
    <span class="n">altitude</span> <span class="o">+=</span> <span class="n">climb_speed</span><span class="p">;</span>
    <span class="n">t_altitude_raw</span><span class="o">-&gt;</span><span class="n">Set_value</span><span class="p">(</span><span class="n">altitude</span><span class="p">);</span>

    <span class="cm">/* Report also some battery value. */</span>
    <span class="n">t_main_voltage</span><span class="o">-&gt;</span><span class="n">Set_value</span><span class="p">(</span><span class="mf">13.5</span><span class="p">);</span>

    <span class="cm">/* Enable ARM command if vehicle is disarmed. */</span>
    <span class="n">c_arm</span><span class="o">-&gt;</span><span class="n">Set_enabled</span><span class="p">(</span><span class="o">!</span><span class="n">is_armed</span><span class="p">);</span>

    <span class="cm">/* Enable DISARM command if vehicle is armed. */</span>
    <span class="n">c_disarm</span><span class="o">-&gt;</span><span class="n">Set_enabled</span><span class="p">(</span><span class="n">is_armed</span><span class="p">);</span>

    <span class="cm">/* Report armed state to the UgCS */</span>
    <span class="n">t_is_armed</span><span class="o">-&gt;</span><span class="n">Set_value</span><span class="p">(</span><span class="n">is_armed</span><span class="p">);</span>

    <span class="cm">/* Send the updated telemetry fields and command states to UgCS</span>
<span class="cm">     * SDK will send only modified values thus saving bandwidth */</span>
    <span class="n">Commit_to_ucs</span><span class="p">();</span>

    <a class="reference internal" href="global.html#doxid-d7-d7f-log-8h-1a159ca84d25a5487d8e81e4438725df19"><span class="std std-ref">LOG</span></a><span></span><span class="p">(</span><span class="s">&quot;send tm&quot;</span><span class="p">);</span>
    <span class="cm">/* Return true to reschedule the same timer again. */</span>
    <span class="k">return</span> <span class="nb">true</span><span class="p">;</span>
<span class="p">}</span></pre>
<p>Telemetry is sent to UgCS by populating the previously registered telemetry fileds with values and then issuing Commit_to_ucs() call. , then filling it with telemetry parameters.</p>
<p>In the example yaw, absolute altitude and battery voltage parameters are sent every second. <em>yaw_speed</em> and <em>climb_speed</em> control the current delta of related parameters to simulate some activity on a vehicle. This activity will be visible in telemetry window when mission is launched.</p>
<p>Now, custom vehicle class is ready to be instantiated and used, but VSM should be initialized before any other VSM services can be used. It is usually done somewhere in the beginning of <em>main</em> function:</p>
<pre class="highlight literal-block"><span></span><span class="cm">/* First of all, initialize SDK infrastructure and services. */</span>
<a class="reference internal" href="namespace_ugcs_vsm.html#doxid-dd-def-namespaceugcs-1-1vsm-1a6a4d1d5dbdddf89a76e16382defa66fa"><span class="std std-ref">ugcs::vsm::Initialize</span></a><span></span><span class="p">();</span></pre>
<p>In a real world VSM application there should be some vehicle specific mechanism which monitors the presence of a vehicle(-s) connection(-s), does initial identifications of a connected vehicle, like serial number and model name reading and then instantiation of a custom vehicle class instance. In the example, however, it is assumed that vehicle is always connected, so instantiation is done immediately after VSM initialization:</p>
<pre class="highlight literal-block"><span></span><span class="cm">/* Create vehicle instance with hard-coded serial number. */</span>
<span class="n">Custom_vehicle</span><span class="o">::</span><span class="n">Ptr</span> <span class="n">vehicle</span> <span class="o">=</span> <span class="n">Custom_vehicle</span><span class="o">::</span><span class="n">Create</span><span class="p">(</span><span class="s">&quot;asd123456&quot;</span><span class="p">);</span>
<span class="cm">/* Should be always called right after vehicle instance creation. */</span>
<span class="n">vehicle</span><span class="o">-&gt;</span><span class="n">Enable</span><span class="p">();</span>
<span class="cm">/* Should be always called after Enable once all the necessary detection is done</span>
<span class="cm"> * and parameters set.</span>
<span class="cm"> */</span>
<span class="n">vehicle</span><span class="o">-&gt;</span><span class="n">Register</span><span class="p">();</span></pre>
<p><a class="reference internal" href="class_ugcs_vsm_Device.html#doxid-d1-dfa-classugcs-1-1vsm-1-1-device-1a6d1d13dd8ae61480c6a063b6e085d844"><span class="std std-ref">ugcs::vsm::Device::Enable</span></a> method should be always called to complete the vehicle instance initialization. As a rule, it should be called right after instance creation with <em>Class::Create</em> method.</p>
<p>After vehicle is enabled, VSM application should control the connection with a vehicle and disable it when connection is totally lost. This logic is VSM specific, but as a general rule, short-term telemetry breaks shouldn’t be considered as connection lost situation. In the example, there is just an infinite wait, assuming that vehicle is always connected and stays alive</p>
<pre class="highlight literal-block"><span></span><span class="cm">/* Now vehicle is visible to UgCS. Requests for the vehicle will be executed</span>
<span class="cm"> * in a dedicated vehicle thread. In a real VSM, there should be some</span>
<span class="cm"> * supervision logic which monitors the connection with a vehicle and</span>
<span class="cm"> * disables it when connection is totally lost. Here it is assumed that</span>
<span class="cm"> * vehicle is always connected, so just wait indefinitely.</span>
<span class="cm"> */</span>
<span class="n">std</span><span class="o">::</span><span class="n">condition_variable</span> <span class="n">cond</span><span class="p">;</span>
<span class="n">std</span><span class="o">::</span><span class="n">mutex</span> <span class="n">mutex</span><span class="p">;</span>
<span class="n">std</span><span class="o">::</span><span class="n">unique_lock</span><span class="o">&lt;</span><span class="n">std</span><span class="o">::</span><span class="n">mutex</span><span class="o">&gt;</span> <span class="n">lock</span><span class="p">(</span><span class="n">mutex</span><span class="p">);</span>
<span class="n">cond</span><span class="p">.</span><span class="n">wait</span><span class="p">(</span><span class="n">lock</span><span class="p">);</span> <span class="cm">/* Infinite wait. */</span></pre>
<p>To gracefully shutdown VSM application, all vehicles should be disabled and VSM terminated:</p>
<pre class="highlight literal-block"><span></span><span class="cm">/* Disable the vehicle, considered to be deleted after that. */</span>
<span class="n">vehicle</span><span class="o">-&gt;</span><span class="n">Disable</span><span class="p">();</span>
<span class="cm">/* Gracefully terminate SDK infrastructure and services. */</span>
<a class="reference internal" href="namespace_ugcs_vsm.html#doxid-dd-def-namespaceugcs-1-1vsm-1a68e200f95017008b9119e042a114f587"><span class="std std-ref">ugcs::vsm::Terminate</span></a><span></span><span class="p">();</span></pre>
</div>
<div class="section" id="cmake-makefile">
<span id="doxid-d8-db6-hello-world-vsm-page-1cmake-hello-world"></span><h2>CMake makefile<a class="headerlink" href="#cmake-makefile" title="Permalink to this headline">¶</a></h2>
<p><a class="reference internal" href="example_Hello_world_VSM_CMakeLists.txt.html#doxid-dc-d9c-hello-world-v-s-m-2-c-make-lists-8txt-example"><span class="std std-ref">Hello_world_VSM/CMakeLists.txt</span></a> is a minimal makefile for VSM application which provides static linkage with SDK library defined by <em>VSM_SDK_DIR</em> variable (either CMake or environment) and a default VSM configuration file via Build_vsm_config() function, which can be given custom source and destination config file locations. It can be considered as a template makefile for VSM applications. Makefile should be self-explanatory. For additional details refer to <a class="reference external" href="http://www.cmake.org">CMake official site</a>.</p>
</div>
<div class="section" id="compilation">
<span id="doxid-d8-db6-hello-world-vsm-page-1hello-world-vsm-compilation"></span><h2>Compilation<a class="headerlink" href="#compilation" title="Permalink to this headline">¶</a></h2>
<p>Prior to compiling the VSM application, SDK should be compiled and installed according to building_page. In the example, it is assumed that source and make file reside in the same directory and <em>VSM_SDK_DIR</em> <em>environment variable</em> points to the SDK installation folder.</p>
<div class="section" id="building">
<span id="doxid-d8-db6-hello-world-vsm-page-1hello-world-vsm-compilation-build"></span><h3>Building<a class="headerlink" href="#building" title="Permalink to this headline">¶</a></h3>
<p>Now VSM application can be compiled and built in the same way as SDK using a single command with a build folder argument, for example:</p>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="n">cmake</span> <span class="o">--</span><span class="n">build</span> <span class="n">build</span><span class="o">-</span><span class="n">debug</span><span class="o">-</span><span class="n">win</span> <span class="o">--</span> <span class="o">-</span><span class="n">j4</span>
</pre></div>
</div>
</div>
</div>
</div>


              </div>
              
              
              <div class='prev-next-bottom'>
                
    <a class='left-prev' id="prev-link" href="page_tutorials_page.html" title="previous page">Tutorials</a>
    <a class='right-next' id="next-link" href="page_license_page.html" title="next page">License</a>

              </div>
              
          </main>
          

      </div>
    </div>
  
  <script src="_static/js/index.1c5a1a01449ed65a7b51.js"></script>

  <footer class="footer mt-5 mt-md-0">
  <div class="container">
    
    <div class="footer-item">
      <p class="copyright">
    &copy; Copyright 2020, SPH Engineering.<br/>
</p>
    </div>
    
    <div class="footer-item">
      <p class="sphinx-version">
Created using <a href="http://sphinx-doc.org/">Sphinx</a> 4.1.1.<br/>
</p>
    </div>
    
  </div>
</footer>
  </body>
</html>